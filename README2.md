# 运营数据同比监测脚本

这个Python脚本用于自动获取扇贝单词应用的运营数据同比分析，重点监控关键指标的同比表现，并具备钉钉预警功能。

## 功能特性

1. ✅ 自动计算昨天的日期和去年同期日期
2. ✅ 调用神策数据API获取同比数据
3. ✅ 解析多个关键指标的当期和同期数据
4. ✅ 自动计算同比增长率
5. ✅ 完整的错误处理机制
6. ✅ 清晰的中文格式化输出
7. ✅ **多重指标预警** - 监控关键转化率和营收指标的同比表现
8. ✅ **异常监控** - API请求失败时自动发送错误通知
9. ✅ **双数据源** - 同时获取单词相关数据和训练营相关数据

## 监测指标

### 单词相关指标（5个）
1. **App 启动的用户数**
2. **考研训练营页面曝光（21～26）的用户数**
3. **考研正课付费合集的用户数**
4. **单词-考研标签点击率** - 🚨 重点监控指标
5. **单词考研标签转化率** - 🚨 重点监控指标

### 训练营相关指标（4个）
1. **考研训练营页面曝光（21～26）的用户数**
2. **考研正课付费合集的用户数**
3. **训练营总营收** - 🚨 重点监控指标
4. **训练营总转化率** - 🚨 重点监控指标

## 预警机制

### 单词相关指标监控
- **单词-考研标签点击率同比**
  - 阈值设定: 10.0% (可在脚本顶部 `CLICK_RATE_THRESHOLD` 变量中修改)
  - 触发条件: 当同比增长率低于10%时
  - 预警消息: "【数据预警】单词-考研标签点击率同比增长为 -55.21%，低于阈值 65.21个百分点，请关注！"

- **单词考研标签转化率同比**
  - 阈值设定: -40.0% (可在脚本顶部 `CONVERSION_RATE_THRESHOLD` 变量中修改)
  - 触发条件: 当同比增长率低于-40%时
  - 预警消息: "【数据预警】单词考研标签转化率同比增长为 -45.50%，低于阈值 5.50个百分点，请关注！"

### 训练营相关指标监控
- **训练营总营收同比**
  - 阈值设定: -10.0% (可在脚本顶部 `TRAINING_REVENUE_THRESHOLD` 变量中修改)
  - 触发条件: 当同比增长率低于-10%时
  - 预警消息: "【数据预警】训练营总营收同比增长为 -27.12%，低于阈值 17.12个百分点，请关注！"

- **训练营总转化率同比**
  - 阈值设定: -10.0% (可在脚本顶部 `TRAINING_CONVERSION_THRESHOLD` 变量中修改)
  - 触发条件: 当同比增长率低于-10%时
  - 预警消息: "【数据预警】训练营总转化率同比增长为 -15.50%，低于阈值 5.50个百分点，请关注！"

### 异常监控
- **触发条件**: API请求失败、数据解析失败等异常情况
- **预警消息**: "【数据预警】获取神策数据失败，请检查脚本！"

### 钉钉配置
- 预警消息会发送到配置的钉钉群聊机器人
- 消息格式符合钉钉机器人API规范
- 包含完整的错误处理和发送状态反馈

## 使用方法

```bash
python3 dau_monitor.py
```

## 输出示例

### 正常情况（所有指标高于阈值）
```
查询日期: 2025-06-24 (同比 2024-06-24)
预警阈值设置:
  - 单词-考研标签点击率同比: < 10.0%
  - 单词考研标签转化率同比: < -40.0%
  - 训练营总营收同比: < -10.0%
  - 训练营总转化率同比: < -10.0%
正在获取单词数据 2025-06-24 与 2024-06-24 的同比数据...
正在获取训练营数据 2025-06-24 与 2024-06-24 的同比数据...
单词-考研标签点击率同比正常: 15.50%
单词考研标签转化率同比正常: 29.53%
训练营总营收同比正常: 5.20%
训练营总转化率同比正常: 12.30%

✅ 成功获取单词相关数据
✅ 成功获取训练营相关数据
```

### 预警情况（部分指标低于阈值）
```
查询日期: 2025-06-24 (同比 2024-06-24)
预警阈值设置:
  - 单词-考研标签点击率同比: < 10.0%
  - 单词考研标签转化率同比: < -40.0%
  - 训练营总营收同比: < -10.0%
  - 训练营总转化率同比: < -10.0%
正在获取单词数据 2025-06-24 与 2024-06-24 的同比数据...
正在获取训练营数据 2025-06-24 与 2024-06-24 的同比数据...
✅ 钉钉预警发送成功: 单词-考研标签点击率同比增长为 -55.21%，低于阈值 65.21个百分点，请关注！
单词考研标签转化率同比正常: 29.53%
✅ 钉钉预警发送成功: 训练营总营收同比增长为 -27.12%，低于阈值 17.12个百分点，请关注！
训练营总转化率同比正常: 34.67%

✅ 成功获取单词相关数据
✅ 成功获取训练营相关数据
```

### 完整数据报告
```
📊 单词相关指标 - 2025-06-24 与 2024-06-24 同比数据
================================================================================

📈 App 启动的用户数:
   当期 (2025-06-24): 186,545
   同期 (2024-06-24): 182,725
   同比增长: +2.09%

📈 考研训练营页面曝光（21～26）的用户数:
   当期 (2025-06-24): 801
   同期 (2024-06-24): 1,759
   同比增长: -54.46%

📈 考研正课付费合集的用户数:
   当期 (2025-06-24): 20
   同期 (2024-06-24): 34
   同比增长: -41.18%

📈 单词-考研标签点击率:
   当期 (2025-06-24): 0.43%
   同期 (2024-06-24): 0.96%
   同比增长: -55.21% ⚠️

📈 单词考研标签转化率:
   当期 (2025-06-24): 2.5%
   同期 (2024-06-24): 1.93%
   同比增长: +29.53% ✅

📊 训练营相关指标 - 2025-06-24 与 2024-06-24 同比数据
================================================================================

📈 考研训练营页面曝光（21～26）的用户数:
   当期 (2025-06-24): 1,603
   同期 (2024-06-24): 2,968
   同比增长: -45.99%

📈 考研正课付费合集的用户数:
   当期 (2025-06-24): 43
   同期 (2024-06-24): 59
   同比增长: -27.12%

📈 训练营总营收:
   当期 (2025-06-24): ¥16,082.00
   同期 (2024-06-24): ¥22,066.00
   同比增长: -27.12% ⚠️

📈 训练营总转化率:
   当期 (2025-06-24): 2.68%
   同期 (2024-06-24): 1.99%
   同比增长: +34.67% ✅
```

## 配置说明

### 修改预警阈值
在脚本顶部找到以下变量进行修改：
```python
CLICK_RATE_THRESHOLD = 10.0  # 单词-考研标签点击率同比增长率阈值（%）
CONVERSION_RATE_THRESHOLD = -40.0  # 单词考研标签转化率同比增长率阈值（%）
TRAINING_REVENUE_THRESHOLD = -10.0  # 训练营总营收同比增长率阈值（%）
TRAINING_CONVERSION_THRESHOLD = -10.0  # 训练营总转化率同比增长率阈值（%）
```

### 配置钉钉Webhook
在脚本顶部找到 `DINGTALK_WEBHOOK_URL` 变量，替换为您的钉钉机器人Webhook地址：
```python
DINGTALK_WEBHOOK_URL = "https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN"
```

## 依赖库

- `requests`: 用于HTTP请求
- `datetime`: 用于日期处理
- `json`: 用于JSON数据解析

安装依赖：
```bash
pip install requests
```

## 核心功能

### 双数据源支持
- **单词相关数据**: 通过第一个API获取单词应用相关的用户行为数据
- **训练营相关数据**: 通过第二个API获取训练营业务相关的营收和转化数据
- **并行处理**: 同时请求两个数据源，提高效率

### 自动日期计算
- 自动获取昨天的日期作为查询日期
- 自动计算去年同期日期进行同比分析

### 智能数据格式化
- **数值类指标**: 使用千分位分隔符格式化
- **百分比指标**: 自动识别并添加%符号
- **货币指标**: 自动识别营收类指标并添加¥符号和货币格式
- **同比增长率**: 自动计算并显示正负号

### 多层次预警
- **单词指标监控**: 监控考研相关内容的点击率和转化率
- **训练营指标监控**: 监控训练营业务的营收和转化效果
- **差异化阈值**: 不同指标设置不同的预警阈值
- **异常监控**: API失败时自动发送错误通知
- **预警状态反馈**: 显示钉钉消息发送成功/失败状态

### 错误处理
- 网络请求异常处理
- JSON数据解析异常处理
- API响应状态检查
- 数据结构验证
- 钉钉预警发送异常处理
- 分别处理两个数据源的异常情况

## 监控逻辑

### 重点关注指标
1. **单词-考研标签点击率同比**: 
   - 正常范围: ≥ 10%
   - 预警条件: < 10%
   - 业务意义: 考研相关内容的吸引力和曝光效果

2. **单词考研标签转化率同比**: 
   - 正常范围: ≥ -40%
   - 预警条件: < -40%
   - 业务意义: 考研用户的付费转化效果

3. **训练营总营收同比**: 
   - 正常范围: ≥ -10%
   - 预警条件: < -10%
   - 业务意义: 训练营业务的总体营收表现

4. **训练营总转化率同比**: 
   - 正常范围: ≥ -10%
   - 预警条件: < -10%
   - 业务意义: 训练营用户的付费转化效果

### 预警触发机制
- 独立监控每个指标的同比增长率
- 分别设置不同的阈值标准
- 实时钉钉预警通知
- 控制台状态显示
- 支持多个指标同时预警

## 定时任务配置

可以通过crontab设置定时任务，每日自动运行监测：

```bash
# 每天上午9:00执行
0 9 * * * cd /path/to/your/script && python3 dau_monitor.py >> monitor.log 2>&1
```

## 注意事项

- 脚本使用神策数据API，需要有效的token才能访问
- 自动查询昨天与去年同期的数据进行同比分析
- 钉钉机器人需要配置正确的access_token
- 重点监控转化率和营收指标的同比表现，而非绝对数值
- 如果网络异常或API返回错误，脚本会自动发送钉钉预警
- 支持所有指标的同比增长率自动计算
- 预警消息会自动添加"【数据预警】"前缀
- 当指标表现正常时，会在控制台显示"正常"状态
- 脚本会同时获取单词相关数据和训练营相关数据
- 训练营营收数据会自动格式化为货币显示（¥符号）
- 即使某个数据源失败，另一个数据源仍可正常工作 